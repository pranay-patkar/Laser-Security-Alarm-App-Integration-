<!DOCTYPE html>
import React, { useState, useEffect, useRef } from 'react';
import { 
  Shield, 
  ShieldAlert, 
  ShieldCheck, 
  Activity, 
  Settings, 
  History, 
  Usb, 
  Zap, 
  Bell, 
  BellOff, 
  Database,
  Terminal,
  Play,
  Volume2,
  AlertTriangle,
  Upload,
  RefreshCw
} from 'lucide-react';

export default function App() {
  // --- System State ---
  const [isConnected, setIsConnected] = useState(false);
  const [isArmed, setIsArmed] = useState(false);
  const [isDemo, setIsDemo] = useState(false);
  const [status, setStatus] = useState('offline'); 
  const [rawVal, setRawVal] = useState(0);
  const [history, setHistory] = useState(new Array(30).fill(0));
  const [logs, setLogs] = useState([]);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [initialized, setInitialized] = useState(false);
  const [isMuted, setIsMuted] = useState(false);
  const [audioError, setAudioError] = useState(false);
  
  // --- Custom Audio State ---
  const [customAudioName, setCustomAudioName] = useState('Tactical_Beep.mp3');
  const DEFAULT_ALARM = 'https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3';

  // --- Refs ---
  const portRef = useRef(null);
  const readerRef = useRef(null);
  const demoIntervalRef = useRef(null);
  const alarmRef = useRef(null);
  const armRef = useRef(null);
  const fileInputRef = useRef(null);

  // --- Audio Initialization ---
  useEffect(() => {
    alarmRef.current = new Audio(DEFAULT_ALARM);
    armRef.current = new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3');
    
    alarmRef.current.loop = true;
    alarmRef.current.volume = 1.0;
    armRef.current.volume = 0.6;

    return () => {
      if (alarmRef.current) {
        alarmRef.current.pause();
        alarmRef.current.src = "";
      }
    };
  }, []);

  // --- Simulation Logic ---
  useEffect(() => {
    if (isDemo) {
      demoIntervalRef.current = setInterval(() => {
        const simulatedVal = Math.floor(Math.random() * 100) + 850;
        setRawVal(simulatedVal);
        setHistory(prev => [...prev.slice(1), simulatedVal]);
      }, 100);
    } else {
      clearInterval(demoIntervalRef.current);
      if (!isConnected) setRawVal(0);
    }
    return () => clearInterval(demoIntervalRef.current);
  }, [isDemo, isConnected]);

  // --- Serial Communication ---
  const connectUSB = async () => {
    try {
      const port = await navigator.serial.requestPort();
      await port.open({ baudRate: 9600 });
      portRef.current = port;
      setIsConnected(true);
      setIsDemo(false);
      setStatus('ready');
      addLog('System', 'USB Hardware Link Established', 'info');
      readSerial();
    } catch (err) {
      addLog('System', 'Connection Failed: ' + err.message, 'error');
    }
  };

  const readSerial = async () => {
    const decoder = new TextDecoder();
    while (portRef.current?.readable) {
      readerRef.current = portRef.current.readable.getReader();
      try {
        while (true) {
          const { value, done } = await readerRef.current.read();
          if (done) break;
          const text = decoder.decode(value).trim();
          const valMatch = text.match(/\[VAL:(\d+)\]/);
          if (valMatch) {
            const num = parseInt(valMatch[1]);
            setRawVal(num);
            setHistory(prev => [...prev.slice(1), num]);
          }
          if (text.includes("INTRUSION")) handleBreach();
        }
      } catch (err) {
        setIsConnected(false);
        setStatus('offline');
      } finally {
        readerRef.current.releaseLock();
      }
    }
  };

  // --- Security Logic ---
  const handleBreach = () => {
    if (status === 'armed') {
      setStatus('alert');
      addLog('Security', 'Perimeter Breach Detected!', 'critical');
      triggerAlarmAudio();
    }
  };

  const triggerAlarmAudio = () => {
    if (isMuted || !alarmRef.current) return;
    alarmRef.current.currentTime = 0;
    alarmRef.current.play().catch(err => setAudioError(true));
  };

  const toggleArm = () => {
    if (status === 'alert') return;
    const nextArmed = !isArmed;
    setIsArmed(nextArmed);
    setStatus(nextArmed ? 'armed' : 'ready');
    
    if (!isMuted && armRef.current) {
        armRef.current.currentTime = 0;
        armRef.current.play().catch(() => {});
    }
    addLog('System', nextArmed ? 'Security perimeter engaged' : 'System disarmed', 'info');

    if (isDemo && nextArmed) {
      setTimeout(() => {
        setStatus(current => {
          if (current === 'armed') {
            handleBreach();
            return 'alert';
          }
          return current;
        });
      }, 5000);
    }
  };

  const resetAlarm = () => {
    setStatus('armed');
    if (alarmRef.current) {
        alarmRef.current.pause();
        alarmRef.current.currentTime = 0;
    }
    addLog('Security', 'Alarm manually cleared', 'info');
  };

  // --- Custom Audio Logic ---
  const handleAudioUpload = (event) => {
    const file = event.target.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      alarmRef.current.pause();
      alarmRef.current.src = url;
      alarmRef.current.load();
      setCustomAudioName(file.name);
      addLog('Audio', `Custom sound loaded: ${file.name}`, 'info');
      // Test beep to ensure unlocked
      alarmRef.current.play().then(() => {
        setTimeout(() => {
           alarmRef.current.pause();
           alarmRef.current.currentTime = 0;
        }, 1000);
      });
    }
  };

  const resetToDefaultAudio = () => {
    alarmRef.current.src = DEFAULT_ALARM;
    alarmRef.current.load();
    setCustomAudioName('Tactical_Beep.mp3');
    addLog('Audio', 'Restored default alarm sound', 'info');
  };

  const addLog = (category, message, level) => {
    setLogs(prev => [{
      id: Date.now(),
      time: new Date().toLocaleTimeString(),
      category,
      message,
      level
    }, ...prev].slice(0, 50));
  };

  const startApp = () => {
    setInitialized(true);
    if (alarmRef.current && armRef.current) {
        alarmRef.current.load();
        armRef.current.load();
        const unlock = (audio) => {
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
            }).catch(() => {});
        };
        unlock(alarmRef.current);
        unlock(armRef.current);
    }
  };

  const testAlarmSound = () => {
    if (!alarmRef.current) return;
    alarmRef.current.currentTime = 0;
    alarmRef.current.play()
      .then(() => {
          setAudioError(false);
          setTimeout(() => {
            alarmRef.current.pause();
            alarmRef.current.currentTime = 0;
          }, 2000);
      })
      .catch(() => setAudioError(true));
  };

  if (!initialized) {
    return (
      <div className="min-h-screen bg-slate-950 flex items-center justify-center p-6 text-white font-sans">
        <div className="max-w-md w-full text-center space-y-8 animate-in fade-in zoom-in duration-500">
          <div className="relative">
             <div className="absolute inset-0 bg-indigo-500 blur-3xl opacity-20"></div>
             <div className="w-24 h-24 glass rounded-3xl flex items-center justify-center mx-auto border border-indigo-500/30 relative z-10">
                <Shield className="w-12 h-12 text-indigo-500" />
             </div>
          </div>
          <div className="space-y-2">
            <h1 className="text-4xl font-black italic tracking-tighter uppercase leading-none">Sentry<span className="text-indigo-500">Tactical</span></h1>
            <p className="text-slate-500 text-[10px] font-bold uppercase tracking-[0.2em]">Hardware Authorization Protocol</p>
          </div>
          <button 
            onClick={startApp}
            className="w-full py-5 bg-indigo-600 rounded-2xl font-black tracking-widest text-sm shadow-2xl shadow-indigo-600/40 hover:bg-indigo-500 transition-all active:scale-95"
          >
            INITIALIZE COMMAND CORE
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 font-sans selection:bg-indigo-500/30 overflow-hidden flex flex-col">
      <div className={`fixed inset-0 pointer-events-none transition-all duration-1000 z-0 ${
        status === 'alert' ? 'bg-red-600/20 animate-pulse' : ''
      }`} />

      {/* Header */}
      <header className="p-4 border-b border-white/5 bg-slate-900/40 backdrop-blur-xl flex justify-between items-center z-50">
        <div className="flex items-center gap-4">
          <div className={`w-3 h-3 rounded-full transition-all duration-500 ${
            status === 'alert' ? 'bg-red-500 shadow-[0_0_12px_#ef4444]' :
            status === 'armed' ? 'bg-indigo-500 shadow-[0_0_12px_#6366f1]' :
            isConnected ? 'bg-emerald-500' : isDemo ? 'bg-amber-500 animate-pulse' : 'bg-slate-700'
          }`} />
          <h1 className="font-black italic tracking-tighter text-xl leading-none uppercase">Sentry<span className="text-indigo-500">Pro</span></h1>
        </div>

        <div className="flex items-center gap-2">
          <button 
            onClick={() => setIsDemo(!isDemo)}
            className={`flex items-center gap-2 px-3 py-2 rounded-xl text-[10px] font-bold tracking-widest border transition-all ${
                isDemo ? 'bg-amber-500/10 border-amber-500/40 text-amber-500' : 'bg-white/5 border-white/10 text-slate-400 hover:bg-white/10'
            }`}
          >
            <Play size={12} fill={isDemo ? "currentColor" : "none"} /> {isDemo ? 'SIM_ON' : 'DEMO'}
          </button>
          
          {!isConnected && (
            <button 
              onClick={connectUSB}
              className="flex items-center gap-2 bg-indigo-600 px-4 py-2 rounded-xl text-[10px] font-black tracking-widest shadow-lg shadow-indigo-600/20 active:scale-95 transition-all"
            >
              <Usb size={14} /> LINK
            </button>
          )}
          
          <button 
            onClick={() => setIsMuted(!isMuted)}
            className={`p-2 rounded-xl border transition-all ${isMuted ? 'border-red-500/30 text-red-400 bg-red-500/5' : 'border-white/5 text-slate-400'}`}
          >
            {isMuted ? <BellOff size={16} /> : <Bell size={16} />}
          </button>
        </div>
      </header>

      {/* Main Panel */}
      <main className="flex-1 overflow-y-auto p-4 md:p-8 relative z-10">
        <div className="max-w-6xl mx-auto">
          
          {activeTab === 'dashboard' && (
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
              <div className="lg:col-span-8 space-y-6">
                <div className={`rounded-[3rem] p-12 text-center transition-all duration-700 border-2 ${
                  status === 'alert' ? 'bg-red-950/40 border-red-500 shadow-2xl' :
                  status === 'armed' ? 'bg-slate-900/60 border-indigo-500/30 shadow-xl' :
                  'bg-slate-900/40 border-white/5'
                }`}>
                  <div className="flex justify-center mb-8">
                    <div className={`p-8 rounded-full transition-all duration-700 ${
                      status === 'alert' ? 'bg-red-500 shadow-[0_0_50px_rgba(239,68,68,0.5)]' :
                      status === 'armed' ? 'bg-indigo-600 shadow-[0_0_30px_rgba(99,102,241,0.3)]' :
                      'bg-slate-800'
                    }`}>
                      {status === 'alert' ? <ShieldAlert size={48} className="text-white" /> :
                       status === 'armed' ? <ShieldCheck size={48} className="text-white" /> :
                       <Shield size={48} className="text-slate-500" />}
                    </div>
                  </div>
                  <h2 className="text-6xl font-black italic tracking-tighter uppercase mb-4 leading-none">
                    {status === 'alert' ? 'Breach' : status === 'armed' ? 'Armed' : 'Standby'}
                  </h2>
                  <p className="text-slate-400 font-medium mb-12 max-w-xs mx-auto text-sm">
                    {status === 'alert' ? 'Security perimeter violated.' :
                     status === 'armed' ? 'Monitoring active.' : 'Hardware link required.'}
                  </p>
                  <div className="flex gap-4 max-w-sm mx-auto">
                    {status === 'alert' ? (
                      <button onClick={resetAlarm} className="flex-1 py-5 bg-white text-slate-950 font-black rounded-3xl shadow-2xl active:scale-95 transition-all text-sm uppercase tracking-widest">
                        Reset Security
                      </button>
                    ) : (
                      <button 
                        disabled={!isConnected && !isDemo}
                        onClick={toggleArm}
                        className={`flex-1 py-5 rounded-3xl font-black tracking-widest text-sm transition-all shadow-xl active:scale-95 ${
                          (!isConnected && !isDemo) ? 'bg-slate-800 text-slate-600 cursor-not-allowed' :
                          status === 'armed' ? 'bg-slate-800 text-red-400 border border-red-500/20' :
                          'bg-indigo-600 text-white shadow-indigo-600/30'
                        }`}
                      >
                        {status === 'armed' ? 'Disarm' : 'Arm Perimeter'}
                      </button>
                    )}
                  </div>
                </div>

                <div className="bg-slate-900/40 border border-white/5 rounded-[2.5rem] p-8 glass">
                  <div className="flex justify-between items-center mb-8">
                    <div className="flex items-center gap-3">
                      <Activity className="text-indigo-400" size={18} />
                      <h3 className="text-xs font-bold uppercase tracking-[0.2em] text-slate-500">Live Signal</h3>
                    </div>
                    <span className="font-mono text-xl font-bold text-indigo-400 w-12 text-right">{String(rawVal).padStart(3, '0')}</span>
                  </div>
                  <div className="h-24 flex items-end gap-1 px-2">
                    {history.map((val, i) => (
                      <div key={i} className={`flex-1 rounded-t-sm transition-all duration-300 ${val < 500 ? 'bg-red-500/40' : 'bg-indigo-500/20'}`} style={{ height: `${(val / 1023) * 100}%` }} />
                    ))}
                  </div>
                </div>
              </div>

              <div className="lg:col-span-4 space-y-6">
                <div className="bg-slate-900/40 border border-white/5 rounded-[2.5rem] flex flex-col h-[550px] glass">
                  <div className="p-6 border-b border-white/5 flex justify-between items-center">
                    <div className="flex items-center gap-3">
                      <Terminal className="text-slate-500" size={14} />
                      <h3 className="text-[10px] font-bold uppercase tracking-widest text-slate-400">Tactical Logs</h3>
                    </div>
                  </div>
                  <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                    {logs.map(log => (
                        <div key={log.id} className="bg-white/5 p-4 rounded-2xl border border-white/5 animate-in slide-in-from-right-4">
                          <div className="flex justify-between items-start mb-1">
                            <span className={`text-[8px] font-black uppercase tracking-widest px-1.5 py-0.5 rounded ${log.level === 'critical' ? 'bg-red-500 text-white' : 'text-slate-400 bg-white/10'}`}>{log.category}</span>
                            <span className="text-[8px] font-mono text-slate-600">{log.time}</span>
                          </div>
                          <p className={`text-[11px] font-semibold leading-relaxed ${log.level === 'critical' ? 'text-red-400' : 'text-slate-300'}`}>{log.message}</p>
                        </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          {activeTab === 'settings' && (
            <div className="max-w-2xl mx-auto space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div className="space-y-2">
                    <h2 className="text-2xl font-black italic uppercase tracking-tighter">Hardware Configuration</h2>
                    <p className="text-slate-500 text-sm italic">Deep customize security protocols and sounds.</p>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Audio Configuration Card */}
                    <div className="bg-slate-900/40 border border-white/5 p-8 rounded-[2rem] glass space-y-6">
                        <div className="flex items-center gap-3">
                            <Volume2 className="text-indigo-400" size={20} />
                            <h3 className="text-sm font-bold uppercase tracking-widest">Alarm Sound</h3>
                        </div>
                        
                        <div className="space-y-4">
                            <div className="p-4 rounded-2xl bg-white/5 border border-white/5">
                                <span className="text-[9px] font-bold text-slate-500 uppercase block mb-1">Active File</span>
                                <span className="text-xs font-mono text-indigo-400 truncate block">{customAudioName}</span>
                            </div>

                            <div className="flex flex-col gap-2">
                                <button 
                                    onClick={() => fileInputRef.current.click()}
                                    className="w-full py-4 bg-indigo-600/10 border border-indigo-500/30 rounded-2xl text-[10px] font-black tracking-widest uppercase hover:bg-indigo-600/20 text-indigo-400 flex items-center justify-center gap-2 transition-all"
                                >
                                    <Upload size={14} /> Upload MP3/WAV
                                </button>
                                <input 
                                    type="file" 
                                    ref={fileInputRef} 
                                    className="hidden" 
                                    accept="audio/*" 
                                    onChange={handleAudioUpload} 
                                />
                                <button 
                                    onClick={resetToDefaultAudio}
                                    className="w-full py-4 bg-white/5 border border-white/10 rounded-2xl text-[10px] font-black tracking-widest uppercase hover:bg-white/10 text-slate-400 flex items-center justify-center gap-2 transition-all"
                                >
                                    <RefreshCw size={14} /> Restore Default
                                </button>
                            </div>

                            <button 
                                onClick={testAlarmSound}
                                className="w-full py-4 bg-white text-slate-950 rounded-2xl text-[10px] font-black tracking-widest uppercase shadow-xl active:scale-95 transition-all"
                            >
                                Test Sound Output
                            </button>
                        </div>
                    </div>

                    {/* Stats Card */}
                    <div className="bg-slate-900/40 border border-white/5 p-8 rounded-[2rem] glass space-y-4">
                        <div className="flex items-center gap-3">
                            <Database className="text-amber-400" size={20} />
                            <h3 className="text-sm font-bold uppercase tracking-widest">Protocol Stats</h3>
                        </div>
                        <div className="space-y-3">
                            <div className="flex justify-between text-[10px] border-b border-white/5 pb-2">
                                <span className="text-slate-500 font-bold uppercase">Mode</span>
                                <span className="text-indigo-400 font-black">{isDemo ? 'SIM_ACTIVE' : 'HARDWARE'}</span>
                            </div>
                            <div className="flex justify-between text-[10px] border-b border-white/5 pb-2">
                                <span className="text-slate-500 font-bold uppercase">Baud</span>
                                <span className="text-emerald-400 font-black">9600</span>
                            </div>
                        </div>
                        {audioError && (
                             <p className="text-[9px] text-red-500 font-bold bg-red-500/10 p-2 rounded-lg text-center border border-red-500/20">
                                Browser security blocked audio. Interact with page to fix.
                             </p>
                        )}
                    </div>
                </div>
            </div>
          )}
        </div>
      </main>

      {/* Navigation */}
      <footer className="p-6 pt-2 bg-slate-900/60 backdrop-blur-2xl border-t border-white/5 z-50">
        <div className="max-w-md mx-auto flex justify-around items-center">
          <button onClick={() => setActiveTab('dashboard')} className={`p-4 rounded-2xl transition-all ${activeTab === 'dashboard' ? 'text-indigo-500 bg-indigo-500/10' : 'text-slate-600 hover:text-slate-400'}`}>
            <Zap size={20} />
          </button>
          <button onClick={() => setActiveTab('settings')} className={`p-4 rounded-2xl transition-all ${activeTab === 'settings' ? 'text-indigo-500 bg-indigo-500/10' : 'text-slate-600 hover:text-slate-400'}`}>
            <Settings size={20} />
          </button>
        </div>
      </footer>

      <style dangerouslySetInnerHTML={{ __html: `
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.05); border-radius: 10px; }
      `}} />
    </div>
  );
}
